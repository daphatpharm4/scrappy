apiVersion: batch/v1
kind: CronJob
metadata:
  name: pipeline-runner
  namespace: adl-jobs
  labels:
    app: pipeline-runner
spec:
  schedule: {{ .Values.pipeline.schedule | quote }}
  concurrencyPolicy: {{ .Values.pipeline.concurrencyPolicy }}
  startingDeadlineSeconds: {{ .Values.pipeline.startingDeadlineSeconds }}
  jobTemplate:
    spec:
      backoffLimit: {{ .Values.pipeline.backoffLimit }}
      activeDeadlineSeconds: {{ .Values.pipeline.activeDeadlineSeconds }}
      ttlSecondsAfterFinished: {{ .Values.pipeline.ttlSecondsAfterFinished }}
      template:
        metadata:
          annotations:
            azure.workload.identity/use: "true"
          labels:
            app: pipeline-runner
        spec:
          serviceAccountName: pipeline-sa
          restartPolicy: Never
          containers:
            - name: pipeline-runner
              image: "{{ required "registry" .Values.global.images.registry }}/{{ .Values.global.images.pipeline.repository }}:{{ .Values.global.images.pipeline.tag }}"
              args: ["africa-datalayer", "ingest-and-cleanse", "--config", "/configs/datasets.yaml"]
              volumeMounts:
                - name: datasets-config
                  mountPath: /configs
              env:
                - name: AZURE_CLIENT_ID
                  value: {{ required "pipeline workload identity clientId is required" .Values.global.azure.pipelineClientId | quote }}
                - name: AZURE_TENANT_ID
                  value: {{ required "tenantId required" .Values.global.azure.tenantId | quote }}
                - name: AZURE_STORAGE_ACCOUNT
                  value: {{ .Values.global.azure.storageAccount | quote }}
                - name: BLOB_CONTAINER
                  value: {{ .Values.global.azure.blobContainer | quote }}
                - name: BLOB_PREFIX_RAW
                  value: {{ .Values.global.azure.blobPrefixRaw | quote }}
                - name: BLOB_PREFIX_CLEAN
                  value: {{ .Values.global.azure.blobPrefixClean | quote }}
                - name: BLOB_PREFIX_CURATED
                  value: {{ .Values.global.azure.blobPrefixCurated | quote }}
                - name: RUN_MODE
                  value: {{ .Values.pipeline.runMode | quote }}
                - name: LOG_LEVEL
                  value: {{ .Values.pipeline.logLevel | quote }}
              resources:
                requests:
                  cpu: {{ .Values.pipeline.resources.requests.cpu | quote }}
                  memory: {{ .Values.pipeline.resources.requests.memory | quote }}
                limits:
                  cpu: {{ .Values.pipeline.resources.limits.cpu | quote }}
                  memory: {{ .Values.pipeline.resources.limits.memory | quote }}
          volumes:
            - name: datasets-config
              configMap:
                name: pipeline-datasets
                items:
                  - key: datasets.yaml
                    path: datasets.yaml
